myApp.controller("CheckMachineAddController",function(n,t,i,r,u,f){function o(n,t){var i=(n.getDate()<10?"0":"")+n.getDate(),r=(n.getMonth()+1<10?"0":"")+(n.getMonth()+1),u=n.getFullYear();return t.replace("dd",i).replace("MM",r).replace("yyyy",u)}function s(){f.get(rootService+"CreateApplyHandlerApp.ashx?act=getlistasset",null,function(t){try{for(var i=0;i<t.length;i++)t[i].AssetID*=1;t.unshift({AssetID:0,AssetCodeName:"-Chọn loại tài sản-"});n.assets=t}catch(r){alert("Lỗi lấy danh sách tài sản")}},function(){alert("Lấy danh sách tài sản bị lỗi")})}function h(){f.get(rootService+"CreateApplyHandlerApp.ashx?act=getdeptdatatable",null,function(t){try{t&&t.unshift({DeptID:0,DeptName:"-Chọn bộ phận-"});n.depts=t;for(var i=0;i<n.depts.length;i++)n.depts[i].DeptID*=1}catch(r){alert("Lỗi lấy danh sách tài sản")}},function(){alert("Lấy danh sách tài sản bị lỗi")})}function c(t){var i={act:"getmachinecheckdailydatatable",asid:t,mcid:0};f.get(rootService+"CreateApplyHandlerApp.ashx",i,function(t){for(var i=0;i<t.length;i++)item=t[i],item.Status=item.Status==null?"Y":item.Status;n.invoice.checks=t},function(){alert("Lấy chi tiết check của tài sản bị lỗi")})}function l(t){var i={act:"getdetailmachinedatatable",mcid:t},r=u(function(r,u){f.get(rootService+"CreateApplyHandlerApp.ashx",i,function(i){n.invoice=i[0];n.invoice.CheckMachineID=t;var u=i[0].CheckDate;n.invoice.CheckDate=u.slice(0,2)+"/"+u.slice(2,4)+"/"+u.slice(4);r(t)},function(n){u(n);alert("Lấy phiếu kiểm bị lỗi")})});r.then(function(n){a(n)}).catch(function(){alert("Lỗi lấy thông tin phiếu")})}function a(t){var i={act:"getmachinecheckdailydatatable",mcid:t,asid:n.invoice.AssetID};f.get(rootService+"CreateApplyHandlerApp.ashx",i,function(t){n.invoice.checks=t},function(){alert("Lấy chi tiết check bị lỗi")})}function e(t){var i={act:t=="T"?"unapprovedmachine":"approvedmachine",mcid:n.invoice.CheckMachineID,status:t,note:""};f.get(rootService+"CreateApplyHandlerApp.ashx",i,function(t){t[0].result==0?n.back():alert("Lỗi khi duyệt phiếu")},function(){alert("Lỗi duyệt phiếu")})}function v(){try{var t=r.search().id;n.isAdd=t==0;t!=0?l(t):n.invoice.CheckDate=o(new Date,"dd/MM/yyyy");s();h()}catch(i){alert(i.message)}}n.ready=!1;n.message="";n.isAdd=!1;n.pageApprove=r.search().status=="D";n.invoice={CheckMachineID:0,DeptID:0,AssetID:0,Status:"M",checks:[],CheckDate:""};n.assets=[];n.depts=[];n.$watch("invoice.AssetID",function(t,i){t!=i&&n.ready&&c(n.invoice.AssetID)});n.save=function(){var t=n.invoice,r,i,u,e;if(t.DeptID==0||t.AssetID==0){n.message="Vui lòng chọn bộ phận và tài sản";return}for(r="",i=0;i<t.checks.length;i++)u=t.checks[i],r+=u.CheckID+"-"+u.Status+";";e={act:"createmachine",mcid:t.CheckMachineID*1,dpid:t.DeptID*1,asid:t.AssetID,dateCheck:n.invoice.CheckDate.replace(/\//g,""),lstCheck:r.slice(0,-1)};f.get(rootService+"CreateApplyHandlerApp.ashx",e,function(t){t[0].result==0?n.back():n.message=t[0].status},function(){n.message("Tạo đơn thất bại")})};n.approve=function(n){if(n=="Y")confirm("Bạn chắc chắn muốn duyệt đơn này?")&&e(n);else if(n=="D")e(n);else{var t=prompt("Lý do");t!=""&&e(n,t)}};n.checkStatus=function(t){n.invoice.checks[t].Status=n.invoice.checks[t].Status=="Y"?"N":"Y"};n.back=function(n){if(n)return"checkMachine?status={status}".replace("{status}",r.search().status);location.href="#checkMachine?status={status}".replace("{status}",r.search().status)};v()});myApp.controller("CheckMachineController",function(n,t,i,r,u,f){function e(){n.getInvoices()}n.paging=f.getPaging();n.pageApprove=r.search().status=="D";n.invoices=[];n.getInvoices=function(){var t={act:"getcheckmachinedatatable",psize:n.paging.getRowCount(),status:n.pageApprove?"D":"",tabid:n.pageApprove?100:96};u.get2(rootService+"GetApplyHandlerApp.ashx",t,function(t){f.permission=t.Permission[0];n.invoices=t.ListData},function(){alert("Lấy danh sách phiếu kiểm bị lỗi")})};n.getInvoice=function(n){location.href="#checkMachineAdd?id={id}&status={status}".replace("{id}",n).replace("{status}",r.search().status)};n.loadMore=function(){n.paging.pageIndex++;n.getInvoices()};e()});myApp.controller("HomeController",function(n,t,i,r){function f(){}var u=0;r.menus=[{menuId:u++,menuName:"Trang chủ",href:"#home",classIcon:"glyphicon glyphicon-home",showAll:!1},{menuId:u++,menuName:"Phiếu kiểm tra máy",href:"#checkMachine",classIcon:"glyphicon glyphicon-list-alt",showAll:!0},{menuId:u++,menuName:"Duyệt phiếu kiểm tra máy",href:"#checkMachine?status=D",classIcon:"glyphicon glyphicon-list-alt",showAll:!0},{menuId:u++,menuName:"Phiếu bảo trì",href:"#maintain",classIcon:"glyphicon glyphicon-wrench",showAll:!0},{menuId:u++,menuName:"Xác nhận phiếu bảo trì",href:"#maintainX",classIcon:"glyphicon glyphicon-wrench",showAll:!0},{menuId:u++,menuName:"Phiếu yêu cầu vật tư",href:"#materialRequest",classIcon:"glyphicon glyphicon-briefcase",showAll:!0},{menuId:u++,menuName:"Phiếu nhập hàng",href:"#merchandise",classIcon:"glyphicon glyphicon-import",showAll:!0},{menuId:u++,menuName:"Phiếu xuất kho",href:"#rotateDepot",classIcon:"glyphicon glyphicon-export",showAll:!0},{menuId:u++,menuName:"Phiếu nhận hàng",href:"#rotateDepot?status=Y",classIcon:"glyphicon glyphicon-retweet",showAll:!0},{menuId:u++,menuName:"Đăng xuất",href:"#login",classIcon:"glyphicon glyphicon-log-out",showAll:!1},];f()});myApp.controller("LoginController",function(n,t,i,r){function f(){}n.username="";n.password="";r.user={username:""};r.permission={};n.login=function(){var t={act:"getlogin",u:n.username,p:n.password};u.get(rootService+"LoginHandlerApp.ashx",t,function(t){t.result==1?(r.user=t,location.href="#home"):n.loginFail=!0},function(){alert("Đăng nhập thất bại")})};var u={get:function(n,i,r,u){$.ajax({method:"get",url:n,data:i,async:!0,headers:{"Content-Type":"application/json"},timeout:2e3}).then(function(n){t(function(){r(n.ListUser[0])},10)},function(){u()})}};f()});myApp.controller("MaintainAddController",function(n,t,i,r,u){function e(t){var i={act:"getdetailreceiptsdatatable",crid:t};u.get(rootService+"CreateApplyHandlerApp.ashx",i,function(t){n.invoice=t[0];n.invoice.DeptID=0},function(){alert("Lấy phiếu kiểm bị lỗi")})}function f(n,t){var f=r.search().status=="H",i={act:n?"approvedreceipts":"unapprovedreceipts",crid:r.search().id,status:n?"H":"T",note:t};u.get(rootService+"CreateApplyHandlerApp.ashx",i,function(n){n[0].result==0?($(".modal-backdrop").remove(),location.href="#maintain"):alert("Lỗi khi duyệt phiếu")},function(){alert("Lỗi duyệt phiếu")})}function o(t){var i={act:"getreceiptsdetailtable",crid:t};u.get(rootService+"CreateApplyHandlerApp.ashx",i,function(t){n.details=t;console.log(n.details)},function(){alert("Lấy chi tiết bị lỗi")})}function s(){u.get(rootService+"CreateApplyHandlerApp.ashx?act=getdeptdatatable",null,function(t){try{t&&t.unshift({DeptID:0,DeptName:"-Chọn bộ phận-"});n.depts=t;for(var i=0;i<n.depts.length;i++)n.depts[i].DeptID*=1}catch(r){alert("Lỗi lấy danh sách tài sản")}},function(){alert("Lấy danh sách tài sản bị lỗi")})}function h(){var n=r.search().id;e(n);o(n);s()}n.invoice={};n.details=[];n.depts=[];n.approve=function(t){if(t){if(n.invoice.DeptID==0){alert("Vui lòng chọn bộ phận");return}f(t)}else{var i=prompt("Lý do");i!=""&&i!=null&&f(t,i)}};h()});myApp.controller("MaintainController",function(n,t,i,r,u,f){function e(){n.getInvoice()}n.paging=f.getPaging();n.invoices=[];n.getInvoice=function(){var t={act:n.isPageFinish?"getcreatereceiptsdatatable":"getreceiptsdatatable",status:"D",psize:n.paging.getRowCount(),tabid:101};u.get2(rootService+"GetApplyHandlerApp.ashx",t,function(t){f.permission=t.Permission[0];n.invoices=t.ListData},function(){alert("Lấy danh sách phiếu kiểm bị lỗi")})};n.getDetail=function(n){location.href="#maintainAdd?id={id}".replace("{id}",n)};n.loadMore=function(){n.paging.pageIndex++;n.getInvoice()};e()});myApp.controller("MaintainXAddController",function(n,t,i,r,u){function e(t){var i={act:"getdetailreceiptsdatatable",crid:t};u.get(rootService+"CreateApplyHandlerApp.ashx",i,function(t){n.invoice=t[0]},function(){alert("Lấy phiếu kiểm bị lỗi")})}function f(n,t){var i={act:n?"approvedreceipts":"unapprovedreceipts",crid:r.search().id,status:n?"X":"Y",note:t};u.get(rootService+"CreateApplyHandlerApp.ashx",i,function(n){n[0].result==0?location.href="#maintainX":alert("Lỗi khi duyệt phiếu")},function(){alert("Lỗi duyệt phiếu")})}function o(t){var i={act:"getreceiptsdetailtable",crid:t};u.get(rootService+"CreateApplyHandlerApp.ashx",i,function(t){n.details=t;console.log(n.details)},function(){alert("Lấy chi tiết bị lỗi")})}function s(){var n=r.search().id;e(n);o(n)}n.invoice={};n.details=[];n.depts=[];n.approve=function(n){if(n)confirm("Bạn chắc chắn muốn duyệt đơn này?")&&f(n);else{var t=prompt("Lý do");t!=""&&t!=null&&f(n,t)}};s()});myApp.controller("MaintainXController",function(n,t,i,r,u){function f(){n.getInvoice()}n.paging=u.getPaging();n.invoices=[];n.getInvoice=function(){var t={act:"getreceiptsdatatable",status:"H",psize:n.paging.getRowCount(),tabid:105};r.get2(rootService+"GetApplyHandlerApp.ashx",t,function(t){u.permission=t.Permission[0];n.invoices=t.ListData},function(){alert("Lấy danh sách phiếu kiểm bị lỗi")})};n.getDetail=function(n){location.href="#maintainXAdd?id="+n};n.loadMore=function(){n.paging.pageIndex++;n.getInvoice()};f()});myApp.controller("MaterialRequestAddController",function(n,t,i,r,u){function e(t){var i={act:"getdetailrequest",rqid:t};u.get(rootService+"CreateApplyHandlerApp.ashx",i,function(t){n.invoice=t[0]},function(){alert("Lấy phiếu kiểm bị lỗi")})}function f(n,t){var i={act:n?"approvedreuest":"unapprovedreuest",rqid:r.search().id,status:n?"Y":"T",note:t};u.get(rootService+"CreateApplyHandlerApp.ashx",i,function(n){n[0].result==0?location.href="#materialRequest":alert("Lỗi khi duyệt phiếu")},function(){alert("Lỗi duyệt phiếu")})}function o(t){var i={act:"getdetailrequestdatatable",rqid:t};u.get(rootService+"CreateApplyHandlerApp.ashx",i,function(t){n.details=t;console.log(n.details)},function(){alert("Lấy chi tiết bị lỗi")})}function s(){var n=r.search().id;e(n);o(n)}n.invoice={};n.details=[];n.approve=function(n){if(n)confirm("Bạn chắc chắn muốn duyệt đơn này?")&&f(n);else{var t=prompt("Lý do");t!=""&&t!=null&&f(n,t)}};s()});myApp.controller("MaterialRequestController",function(n,t,i,r,u,f){function e(){n.getInvoice()}n.paging=f.getPaging();n.invoices=[];n.getInvoice=function(){var t={act:"getrequestdatatable",psize:n.paging.getRowCount(),status:"D",tabid:102};u.get2(rootService+"GetApplyHandlerApp.ashx",t,function(t){f.permission=t.Permission[0];n.invoices=t.ListData},function(){alert("Lấy danh sách phiếu kiểm bị lỗi")})};n.getDetail=function(n){location.href="#materialRequestAdd?id="+n};n.loadMore=function(){n.paging.pageIndex++;n.getInvoice()};e()});myApp.controller("MerchandiseAddController",function(n,t,i,r,u){function e(t){var i={act:"getdetailmerchandise",meid:t};u.get(rootService+"CreateApplyHandlerApp.ashx",i,function(t){n.merchandise=t[0]},function(){alert("Lấy phiếu kiểm nhập hàng bị lỗi")})}function f(t,i){var f={act:t?"approvedmerchandise":"unapprovedmerchandise",meid:r.search().id,deid:n.merchandise.DepotID,note:i};u.get(rootService+"CreateApplyHandlerApp.ashx",f,function(n){n[0].result==0?location.href="#merchandise":alert("Lỗi khi duyệt phiếu")},function(){alert("Lỗi duyệt phiếu")})}function o(t){var i={act:"getmerchandisedetailtable",meid:t};u.get(rootService+"CreateApplyHandlerApp.ashx",i,function(t){n.details=t},function(){alert("Lấy chi tiết bị lỗi")})}function s(){var n=r.search().id;e(n);o(n)}n.merchandise={};n.details=[];n.approve=function(n){if(n)confirm("Bạn chắc chắn muốn duyệt đơn này?")&&f(n);else{var t=prompt("Lý do");t!=""&&t!=null&&f(n,t)}};s()});myApp.controller("MerchandiseController",function(n,t,i,r,u,f){function e(){n.getMerchandises()}n.paging=f.getPaging();n.merchandises=[];n.getMerchandises=function(t){t||(n.paging.pageIndex=1);var i={act:"getmerchandisedatatable",psize:n.paging.pageSize*n.paging.pageIndex,tabid:117};u.get2(rootService+"GetApplyHandlerApp.ashx",i,function(t){f.permission=t.Permission[0];n.merchandises=t.ListData},function(){alert("Lấy danh sách đơn nhập hàng bị lỗi")})};n.getMerchandise=function(n){location.href="#merchandiseAdd?id={id}".replace("{id}",n)};n.loadMore=function(){n.paging.pageIndex++;n.getMerchandises(!0)};e()});myApp.controller("RotateDepotAddController",function(n,t,i,r,u){function e(t){var i={act:"getrotatedepotdetail",roid:t};u.get(rootService+"CreateApplyHandlerApp.ashx",i,function(t){n.rotateDepot=t[0]},function(){alert("Lấy phiếu xuất hàng bị lỗi")})}function f(t,i){var f={act:t?"approvedrotatedepot":"unapprovedrotatedepot",roid:r.search().id,note:i,defr:r.search().depotFrom,status:n.isPageReceive?"X":"Y"};u.get(rootService+"CreateApplyHandlerApp.ashx",f,function(t){t[0].result==0?n.back():alert("Lỗi khi duyệt phiếu")},function(){alert("Lỗi duyệt phiếu")})}function o(t){var i={act:"getrotatedepotdetailtable",roid:t};u.get(rootService+"CreateApplyHandlerApp.ashx",i,function(t){n.details=t},function(){alert("Lấy chi tiết bị lỗi")})}function s(){var n=r.search().id;e(n);o(n)}n.rotateDepot={};n.details=[];n.isPageReceive=r.search().status=="Y";n.approve=function(n){if(n)confirm("Bạn chắc chắn muốn duyệt đơn này?")&&f(n);else{var t=prompt("Lý do");t!=""&&t!=null&&f(n,t)}};n.back=function(t){if(t)return"rotateDepot?status={status}".replace("{status}",n.isPageReceive?"Y":"D");location.href="#rotateDepot?status={status}".replace("{status}",n.isPageReceive?"Y":"D")};s()});myApp.controller("RotateDepotController",function(n,t,i,r,u,f){function e(){n.getrotateDepots()}n.paging=f.getPaging();n.isPageReceive=r.search().status=="Y";n.rotateDepots=[];n.getrotateDepots=function(t){t||(n.paging.pageIndex=1);var i={act:"getrotatedepotdatatable",psize:n.paging.getRowCount(),status:n.isPageReceive?"Y":"D",tabid:n.isPageReceive?120:119};u.get2(rootService+"GetApplyHandlerApp.ashx",i,function(t){f.permission=t.Permission[0];n.rotateDepots=t.ListData},function(){alert("Lấy danh sách đơn xuất kho bị lỗi")})};n.getRotateDepot=function(t,i){location.href="#rotateDepotAdd?id={id}&depotFrom={depotFrom}&status={status}".replace("{id}",t).replace("{depotFrom}",i).replace("{status}",n.isPageReceive?"Y":"D")};n.loadMore=function(){n.paging.pageIndex++;n.getrotateDepots(!0)};e()});